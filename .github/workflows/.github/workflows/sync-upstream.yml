name: Sync NostalgiaForInfinity Strategy

  on:
    schedule:
      - cron: '0 */8 * * *'
    workflow_dispatch:
      inputs:
        force_update:
          description: '强制更新(忽略版本检查)'
          required: false
          default: 'false'
          type: boolean

  env:
    UPSTREAM_REPO: iterativv/NostalgiaForInfinity
    UPSTREAM_BRANCH: main
    STRATEGY_FILE: NostalgiaForInfinityX7.py

  jobs:
    check-and-sync:
      runs-on: ubuntu-latest
      permissions:
        contents: write

      steps:
        - name: Checkout Fork
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Configure Git
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

        - name: Add Upstream Remote
          run: |
            git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
            git fetch upstream ${{ env.UPSTREAM_BRANCH }}

        - name: Check for Updates
          id: check_updates
          run: |
            LOCAL_HASH=$(git hash-object ${{ env.STRATEGY_FILE }} 2>/dev/null || echo "none")
            UPSTREAM_HASH=$(git ls-tree upstream/${{ env.UPSTREAM_BRANCH }} --format='%(objectname)' -- ${{ env.STRATEGY_FILE }} 2>/dev/null || echo "none")
            echo "本地: $LOCAL_HASH"
            echo "上游: $UPSTREAM_HASH"
            if [ "$LOCAL_HASH" != "$UPSTREAM_HASH" ] || [ "${{ github.event.inputs.force_update }}" = "true" ]; then
              echo "has_updates=true" >> $GITHUB_OUTPUT
            else
              echo "has_updates=false" >> $GITHUB_OUTPUT
            fi
            echo "upstream_commit=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})" >> $GITHUB_OUTPUT

        - name: Sync from Upstream
          if: steps.check_updates.outputs.has_updates == 'true'
          run: |
            git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit --allow-unrelated-histories || {
              git checkout --theirs .
              git add .
              git commit -m "chore: sync upstream"
            }
            git push origin ${{ env.UPSTREAM_BRANCH }}

        - name: Trigger Webhook
          if: steps.check_updates.outputs.has_updates == 'true'
          run: |
            curl -s -X POST "${{ secrets.WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"action":"sync","message":"策略已更新"}'
